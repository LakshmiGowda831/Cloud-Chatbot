<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cloudy AI - Your Intelligent Assistant</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" fill="url(#heartGradient)" stroke="url(#heartGradient)" stroke-width="0.5"/>
            <defs>
              <linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#FF6B9D"/>
                <stop offset="100%" stop-color="#87CEEB"/>
              </linearGradient>
            </defs>
          </svg>
          <span class="logo-text">Cloudy AI</span>
        </div>
        <div class="header-info">
        </div>
      </div>
    </header>

    <!-- Chat Container -->
    <div class="chat-container">
      <div id="chat-box" class="chat-box">
        <div class="welcome-message">
          <div class="welcome-icon">‚ú®</div>
          <h1>Hello, I'm Cloudy</h1>
          <p>Your intelligent AI assistant. Ask me anything!</p>
          <div class="suggestion-chips">
            <button class="chip" onclick="sendSuggestion('Explain quantum computing in simple terms')">
              <span class="chip-icon">‚öõÔ∏è</span>
              <span class="chip-text">Explain quantum computing</span>
            </button>
            <button class="chip" onclick="sendSuggestion('What\'s the latest news about AI?')">
              <span class="chip-icon">üîç</span>
              <span class="chip-text">Latest AI news</span>
            </button>
            <button class="chip" onclick="sendSuggestion('Write a Python function to sort a list')">
              <span class="chip-icon">üíª</span>
              <span class="chip-text">Python coding help</span>
            </button>
            <button class="chip" onclick="sendSuggestion('Tell me about cloud computing')">
              <span class="chip-icon">‚òÅÔ∏è</span>
              <span class="chip-text">Cloud computing</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="input-area">
      <div class="input-wrapper">
        <div class="input-container">
          <button class="attach-btn" title="Attach file (coming soon)" disabled>
            <span class="material-symbols-outlined">attach_file</span>
          </button>
          <textarea id="user-input" placeholder="Message Cloudy..." rows="1" autofocus></textarea>
          <button id="send-btn" onclick="sendMessage()" disabled>
            <span class="material-symbols-outlined">send</span>
          </button>
        </div>
        <div class="input-footer">
          <div class="footer-left">
            <span id="char-count" class="char-count">0 / 4000</span>
          </div>
          <div class="footer-right">
            <span class="footer-hint">Press <kbd>Enter</kbd> to send, <kbd>Shift + Enter</kbd> for new line</span>
          </div>
        </div>
      </div>
      <div id="error-msg" class="error-msg"></div>
    </div>
  </div>

  <script>
    let isSending = false;
    let messageCount = 0;
    const MAX_CHARS = 4000;

    // Configure marked for better markdown rendering
    marked.setOptions({
      highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
      },
      breaks: true,
      gfm: true
    });

    // Auto-resize textarea
    const textarea = document.getElementById('user-input');
    const charCount = document.getElementById('char-count');
    
    textarea.addEventListener('input', function() {
      // Auto-resize
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 200) + 'px';
      
      // Update character count
      const count = this.value.length;
      charCount.textContent = `${count} / ${MAX_CHARS}`;
      charCount.style.color = count > MAX_CHARS * 0.9 ? '#ea4335' : '#5f6368';
      
      // Enable/disable send button
      const sendBtn = document.getElementById('send-btn');
      sendBtn.disabled = !this.value.trim() || isSending || count > MAX_CHARS;
    });

    async function sendMessage() {
      if (isSending) return;
      
      let input = document.getElementById('user-input');
      let message = input.value.trim();
      
      if (!message) {
        showError('Please type a message!');
        return;
      }
      
      // Hide welcome message on first message
      if (messageCount === 0) {
        const welcome = document.querySelector('.welcome-message');
        if (welcome) welcome.style.display = 'none';
      }
      messageCount++;
      
      isSending = true;
      let sendBtn = document.getElementById('send-btn');
      sendBtn.disabled = true;
      clearError();
      
      let chatBox = document.getElementById('chat-box');
      
      // Add user message with animation
      let userMsgContainer = document.createElement('div');
      userMsgContainer.className = 'message-container user-container';
      userMsgContainer.innerHTML = `
        <div class="message-content">
          <div class="message-avatar">
            <div class="avatar user-avatar">
              <span class="material-symbols-outlined">person</span>
            </div>
          </div>
          <div class="message-body">
            <div class="message-header">
              <span class="message-author">You</span>
              <span class="message-time">${getCurrentTime()}</span>
            </div>
            <div class="message-text user-msg">${escapeHtml(message)}</div>
            <div class="message-actions">
              <button class="action-btn" onclick="copyMessage(this)" title="Copy">
                <span class="material-symbols-outlined">content_copy</span>
              </button>
            </div>
          </div>
        </div>
      `;
      chatBox.appendChild(userMsgContainer);
      
      input.value = '';
      input.style.height = 'auto';
      chatBox.scrollTop = chatBox.scrollHeight;
      
      // Add loading indicator with better animation
      let loadingContainer = document.createElement('div');
      loadingContainer.className = 'message-container bot-container';
      loadingContainer.id = 'loading-msg';
      loadingContainer.innerHTML = `
        <div class="message-content">
          <div class="message-avatar">
            <div class="avatar bot-avatar">
              <span class="avatar-icon">‚ú®</span>
            </div>
          </div>
          <div class="message-body">
            <div class="message-header">
              <span class="message-author">Cloudy</span>
              <span class="message-status">Thinking...</span>
            </div>
            <div class="message-text bot-msg">
              <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
              </div>
            </div>
          </div>
        </div>
      `;
      chatBox.appendChild(loadingContainer);
      smoothScrollToBottom();
      
      try {
        const res = await fetch('/get', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message }),
          timeout: 30000
        });
        
        if (!res.ok) {
          throw new Error(`Server error: ${res.status}`);
        }
        
        const data = await res.json();
        
        // Remove loading indicator
        loadingContainer.remove();
        
        // Add bot message with typing effect
        let botMsgContainer = document.createElement('div');
        botMsgContainer.className = 'message-container bot-container';
        const formattedReply = formatMessage(data.reply || 'Sorry, I could not generate a response.');
        botMsgContainer.innerHTML = `
          <div class="message-content">
            <div class="message-avatar">
              <div class="avatar bot-avatar">
                <span class="avatar-icon">‚ú®</span>
              </div>
            </div>
            <div class="message-body">
              <div class="message-header">
                <span class="message-author">Cloudy</span>
                <span class="message-time">${getCurrentTime()}</span>
              </div>
              <div class="message-text bot-msg" id="bot-msg-${Date.now()}"></div>
              <div class="message-actions">
                <button class="action-btn" onclick="copyMessage(this)" title="Copy">
                  <span class="material-symbols-outlined">content_copy</span>
                </button>
                <button class="action-btn" onclick="regenerateResponse(this)" title="Regenerate">
                  <span class="material-symbols-outlined">refresh</span>
                </button>
                <button class="action-btn" onclick="likeMessage(this)" title="Like">
                  <span class="material-symbols-outlined">thumb_up</span>
                </button>
                <button class="action-btn" onclick="dislikeMessage(this)" title="Dislike">
                  <span class="material-symbols-outlined">thumb_down</span>
                </button>
              </div>
            </div>
          </div>
        `;
        chatBox.appendChild(botMsgContainer);
        
        // Type out the message
        const msgElement = botMsgContainer.querySelector('.message-text');
        typeMessage(msgElement, formattedReply);
        
      } catch (error) {
        console.error('Error:', error);
        loadingContainer.remove();
        showError('Failed to get response. Please try again.');
        
        // Add error message
        let errorContainer = document.createElement('div');
        errorContainer.className = 'message-container bot-container';
        errorContainer.innerHTML = `
          <div class="message-content">
            <div class="message-header">
              <span class="avatar bot-avatar">‚ú®</span>
              <span class="bot-name">Cloudy</span>
            </div>
            <div class="message-text bot-msg error">Sorry, I encountered an error. Please try again!</div>
          </div>
        `;
        chatBox.appendChild(errorContainer);
      } finally {
        isSending = false;
        sendBtn.disabled = false;
        chatBox.scrollTop = chatBox.scrollHeight;
        input.focus();
      }
    }

    function sendSuggestion(text) {
      document.getElementById('user-input').value = text;
      document.getElementById('send-btn').disabled = false;
      sendMessage();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function startNewChat() {
      if (!confirm('Start a new chat? This will clear the current conversation.')) {
        return;
      }
      
      try {
        const res = await fetch('/new-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (res.ok) {
          // Clear chat box
          const chatBox = document.getElementById('chat-box');
          chatBox.innerHTML = `
            <div class="welcome-message">
              <div class="welcome-icon">‚ú®</div>
              <h1>Hello, I'm Cloudy</h1>
              <p>Your intelligent AI assistant. Ask me anything!</p>
              <div class="suggestion-chips">
                <button class="chip" onclick="sendSuggestion('Explain quantum computing in simple terms')">Explain quantum computing</button>
                <button class="chip" onclick="sendSuggestion('What are the benefits of cloud computing?')">Cloud computing benefits</button>
                <button class="chip" onclick="sendSuggestion('Write a Python function to sort a list')">Python coding help</button>
                <button class="chip" onclick="sendSuggestion('Tell me about artificial intelligence')">About AI</button>
              </div>
            </div>
          `;
          messageCount = 0;
          
          // Show success message
          const input = document.getElementById('user-input');
          input.placeholder = 'New chat started! Ask me anything...';
          setTimeout(() => {
            input.placeholder = 'Ask Cloudy anything...';
          }, 2000);
        }
      } catch (error) {
        console.error('Error starting new chat:', error);
        showError('Failed to start new chat. Please try again.');
      }
    }

    function getCurrentTime() {
      const now = new Date();
      return now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    }

    function smoothScrollToBottom() {
      const chatBox = document.getElementById('chat-box');
      chatBox.scrollTo({
        top: chatBox.scrollHeight,
        behavior: 'smooth'
      });
    }

    function typeMessage(element, html, speed = 10) {
      // For now, just set it directly (typing effect can be added later)
      element.innerHTML = html;
      smoothScrollToBottom();
      
      // Highlight code blocks
      element.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
      });
    }

    function formatMessage(text) {
      // Remove "Cloudy ‚òÅÔ∏è:" prefix if present
      text = text.replace(/^Cloudy ‚òÅÔ∏è:\s*/i, '');
      
      // Use marked.js for markdown rendering
      try {
        return marked.parse(text);
      } catch (e) {
        // Fallback to simple formatting
        const tempDiv = document.createElement('div');
        tempDiv.textContent = text;
        return tempDiv.innerHTML.replace(/\n/g, '<br>');
      }
    }

    function copyMessage(btn) {
      const messageText = btn.closest('.message-body').querySelector('.message-text');
      const text = messageText.innerText;
      navigator.clipboard.writeText(text).then(() => {
        const icon = btn.querySelector('.material-symbols-outlined');
        icon.textContent = 'check';
        setTimeout(() => {
          icon.textContent = 'content_copy';
        }, 2000);
      });
    }

    function regenerateResponse(btn) {
      showError('Regenerate feature coming soon!');
    }

    function likeMessage(btn) {
      btn.classList.toggle('active');
      const icon = btn.querySelector('.material-symbols-outlined');
      icon.style.fill = btn.classList.contains('active') ? '1' : '0';
    }

    function dislikeMessage(btn) {
      btn.classList.toggle('active');
      const icon = btn.querySelector('.material-symbols-outlined');
      icon.style.fill = btn.classList.contains('active') ? '1' : '0';
    }

    function showError(msg) {
      let errorDiv = document.getElementById('error-msg');
      errorDiv.textContent = msg;
      errorDiv.style.display = 'block';
      setTimeout(() => clearError(), 5000);
    }

    function clearError() {
      let errorDiv = document.getElementById('error-msg');
      errorDiv.textContent = '';
      errorDiv.style.display = 'none';
    }

    // Send message on Enter key (Shift+Enter for new line)
    textarea.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey && !isSending) {
        e.preventDefault();
        if (this.value.trim()) {
          sendMessage();
        }
      }
    });
  </script>
</body>
</html>
